name: Fetch GitHub Contributions Data

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    # Run weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'

jobs:
  fetch-github-data:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Fetch GitHub Contributions Data
      run: |
        # Create the data directory if it doesn't exist
        mkdir -p data
        
        # Fetch GitHub user data using REST API
        echo "Fetching GitHub user data..."
        curl -s -X GET "https://api.github.com/users/devvyyxyz" \
          -H "Accept: application/vnd.github.v3+json" \
          -o data/github-user.json
        
        echo "✓ User data fetched"
        
        # Fetch user's repositories
        echo "Fetching repositories..."
        curl -s "https://api.github.com/users/devvyyxyz/repos?type=owner&sort=updated&per_page=100" \
          -o data/github-repos.json
        
        echo "✓ Repositories fetched"
        
        # Fetch user's recent activity
        echo "Fetching recent activity..."
        curl -s "https://api.github.com/users/devvyyxyz/events?per_page=100" \
          -H "Accept: application/vnd.github.v3+json" \
          -o data/github-events.json
        
        echo "✓ Recent activity fetched"
        
        # Fetch user's issues (created)
        echo "Fetching issues created..."
        curl -s "https://api.github.com/search/issues?q=author:devvyyxyz+type:issue&per_page=1" \
          -o data/github-issues.json
        
        echo "✓ Issues fetched"
        
        # Fetch user's pull requests
        echo "Fetching pull requests..."
        curl -s "https://api.github.com/search/issues?q=author:devvyyxyz+type:pr&per_page=1" \
          -o data/github-prs.json
        
        echo "✓ Pull requests fetched"
        
        # Compile the data into a single comprehensive file
        echo "Compiling GitHub data..."
        node scripts/compile-github-data.js
        
        echo "✓ GitHub data compiled successfully"
        
        # Verify the output
        if [ -f data/github-data.json ] && grep -q '"success":true' data/github-data.json; then
          echo "✓ Data verification passed"
          cat data/github-data.json | head -20
        else
          echo "✗ Data compilation failed"
          exit 1
        fi

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/github-*.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "Update GitHub contributions data" && git push)
